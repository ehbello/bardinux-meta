#!/bin/bash

set -e

CODENAME=${DIST:-$(lsb_release -cs)}
NAME=${CODENAME}-${ARCH:-$(dpkg-architecture -qDEB_BUILD_ARCH)}

source /etc/update-repo.conf

REPREPRO=/usr/bin/reprepro
REPREPRO_CONF=${REPREPRO_CONF:-/usr/share/bardinux-dev-tools/reprepro-conf/}
LOCAL_REPOSITORY=${LOCAL_REPOSITORY:-/var/pbuilder/archive/}
LOG_FILE=${LOG_FILE:-/var/log/$(basename $0).log}

OPTIONS="-Vb $LOCAL_REPOSITORY $REPREPRO_OPTS"

if [ -d /var/pbuilder/${NAME}/result ]; then
	DERIVATIVE_PACKAGES=$(ls /var/pbuilder/${NAME}/result/*.*{deb,dsc})
fi

until [ -z $1 ]; do
	case $1 in
		--reset)
			RESET=true
			;;
		--replace)
			REPLACE=true
			;;
		-u|--upload)
			UPLOAD=true
			;;
		--help)
			echo "Adds packages to an unstable repository. Support pull and push changes from/to a remote repository."
			echo "Usage: $0 [--revert] [--replace] [-u|--upload] [file.{dsc,udeb,deb}]"
			exit
			;;
		*)
			if [[ $1 =~ ^- ]]; then
				echo "Wrong option: $1"
				exit
			fi
			ARGS="$ARGS $1"
			;;
	esac
	shift
done

if [ $RESET ]; then
	echo -n "Do you really want to pull remote repository (this overwrite local repository)? [y/N]"
	read answer
	if [ "${answer}" = 'y' ] || [ "${answer}" = 'Y' ]; then
		echo "Reverting content of ${LOCAL_REPOSITORY}..."
		rsync -avx --delete ${REMOTE_REPOSITORY} ${LOCAL_REPOSITORY}
	fi
fi

mkdir -p $LOCAL_REPOSITORY/conf
rsync -av --delete $REPREPRO_CONF $LOCAL_REPOSITORY/conf/

# Ready...
# Including packages
for pkg in ${ARGS:-$DERIVATIVE_PACKAGES}; do
	if [ $REPLACE ]; then
		$REPREPRO $OPTIONS remove $CODENAME $(basename ${pkg/_*//})
	fi
	if [[ $pkg =~ \.dsc$ ]]; then
		echo '# dsc #'
		$REPREPRO $OPTIONS -S bardinux -P low includedsc $CODENAME $pkg | tee -a $LOG_FILE
	else	
		if [[ $pkg =~ \.udeb$ ]]; then
			echo '# udeb #'
			$REPREPRO $OPTIONS includeudeb $CODENAME $pkg | tee -a $LOG_FILE
		else
			echo '# deb #'
			$REPREPRO $OPTIONS includedeb $CODENAME $pkg | tee -a $LOG_FILE
		fi
	fi
done

if sed -n '/^Codename: '$CODENAME'/,/^ *$/p' $LOCAL_REPOSITORY/conf/distributions | egrep -q ^SignWith; then
	$REPREPRO $OPTIONS --ask-passphrase export $CODENAME
fi

chmod 755 -R $LOCAL_REPOSITORY

if [ $UPLOAD ]; then
	echo -n "Do you really want to push local repository (this overwrite remote repository)? [y/N]"
	read answer
	if [ "${answer}" = 'y' ] || [ "${answer}" = 'Y' ]; then
		echo "Uploading to ${REMOTE_REPOSITORY}..."
		rsync -avx --delete ${LOCAL_REPOSITORY} ${REMOTE_REPOSITORY}
	fi
fi
