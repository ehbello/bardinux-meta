# kdm - KDE Display Manager
#
# The display manager service manages the X servers running on the
# system, providing login and auto-login services

description     "K Display Manager"
author          "Richard Johnson"  

start on ((filesystem
           and runlevel [!06]
           and started dbus
           and (drm-device-added card0 PRIMARY_DEVICE_FOR_DISPLAY=1
                or stopped udev-fallback-graphics))
          or runlevel PREVLEVEL=S)

stop on runlevel [016]

emits login-session-start
emits desktop-session-start
emits desktop-shutdown

env XORGCONFIG=/etc/X11/xorg.conf

script
    if [ -n "$UPSTART_EVENTS" ]
    then
	[ ! -f /etc/X11/default-display-manager -o "$(cat /etc/X11/default-display-manager 2>/dev/null)" = "/usr/bin/kdm" ] || { stop; exit 0; }

        if [ "$RUNLEVEL" = S -o "$RUNLEVEL" = 1 ]
        then
            # Single-user mode
            plymouth quit || :
            exit 0
        fi
    fi

    if [ -r /etc/default/locale ]; then
        . /etc/default/locale
        export LANG LANGUAGE LC_MESSAGES
    elif [ -r /etc/environment ]; then
        . /etc/environment
        export LANG LANGUAGE LC_MESSAGES
    fi
    export XORGCONFIG

    # parameters to support kdm customization
    KDMRC=/etc/kde4/kdm/kdmrc
    BACKGROUNDRC=/etc/kde4/kdm/backgroundrc

	KDMOVERRIDEDIR=/etc/default/kdm.d
	KDMCFGDIR=/var/run/kdm
	KDMCFG=$KDMCFGDIR/kdmrc
	BACKGROUNDCFG=$KDMCFGDIR/backgroundrc

	test -x $DAEMON || exit 0

	if [ -d "$KDMOVERRIDEDIR" ]; then
		for part in $(run-parts --list "$KDMOVERRIDEDIR" 2>/dev/null || true); do
			. "$part"
		done
	fi

	genkdmconf --in $KDMCFGDIR 1> /dev/null

    if grep -q "^[[:space:]]*Theme=@@@ToBeReplacedByDesktopBase@@@" ${KDMRC}
    then
        sed -i 's|@@@ToBeReplacedByDesktopBase@@@|/usr/share/kde4/apps/kdm/themes/bardinux|' ${KDMCFG}
    fi

    if grep -q "^[[:space:]]*Theme=/usr/share/kde4/apps/kdm/themes/ariya" ${KDMRC} && grep -q "^[[:space:]]*Wallpaper=$" ${BACKGROUNDRC}
    then
        [ -n "$USEBACKGROUND" ] && sed -i "s|^#\?UseBackground=.*|UseBackground=$USEBACKGROUND|" $KDMCFG
        [ -n "$BACKGROUNDCFG" ] && sed -i "s|^#\?BackgroundCfg=.*|BackgroundCfg=$BACKGROUNDCFG|" $KDMCFG
        [ -n "$USETHEME" ] && sed -i "s|^#\?UseTheme=.*|UseTheme=$USETHEME|" $KDMCFG
        [ -n "$THEME" ] && sed -i "s|^#\?Theme=.*|Theme=$THEME|" $KDMCFG
        [ -n "$WALLPAPER" ] && sed -i "s|^#\?Wallpaper=.*|Wallpaper=`readlink -f $WALLPAPER`|" $BACKGROUNDCFG

    fi

    [ -n "$PRESELECTUSER" ] && sed -i "s|^#\?PreselectUser=.*|PreselectUser=$PRESELECTUSER|" $KDMCFG

    if [ -n "$AUTOLOGINUSER" ]; then
        sed -i "s|^#\?AutoLoginEnable=.*|AutoLoginEnable=true|" $KDMCFG
        sed -i "s|^#\?AutoLoginUser=.*|AutoLoginUser=$AUTOLOGINUSER|" $KDMCFG
    fi

    [ -n "$AUTOLOGINDELAY" ] && sed -i "s|^#\?AutoLoginDelay=.*|AutoLoginDelay=$AUTOLOGINDELAY|" $KDMCFG
    [ -n "$AUTOLOGINAGAIN" ] && sed -i "s|^#\?AutoLoginAgain=.*|AutoLoginAgain=$AUTOLOGINAGAIN|" $KDMCFG
    [ -n "$AUTOLOGINLOCKED" ] && sed -i "s|^#\?AutoLoginLocked=.*|AutoLoginLocked=$AUTOLOGINLOCKED|" $KDMCFG

    [ -n "$USESESSREG" ] && sed -i "s|^#\?UseSessReg=.*|UseSessReg=$USESESSREG|" $KDMCFG

    exec kdm -config $KDMCFG
end script

post-stop script
	if [ "$UPSTART_STOP_EVENTS" = runlevel ]; then
		initctl emit desktop-shutdown
	fi
end script
