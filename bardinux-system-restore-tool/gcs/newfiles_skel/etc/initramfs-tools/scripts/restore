#!/bin/bash
# Local filesystem mounting			-*- shell-script -*-

# Parameter: Where to mount the filesystem
#

. /scripts/libbsrt

syncronize () {
	TITLE="Restaurando $1 desde ${BACKUPDEV} a ${ROOTDEV}"
	TEXT="Completado..."
	mount_dev ro ${BACKUPDEV} /source
	mount_dev rw ${ROOTDEV} /target
	rsync -ax --progress --delete /source/${SNAPSHOTDIR}/$1 /target/
	ERROR=$?
	umount ${ROOTDEV}
	umount ${BACKUPDEV}
	return ${ERROR}
}

getSnapshots() {
	mount_dev ro ${BACKUPDEV} /mnt

	for ID in /mnt/${SNAPSHOTDIR}/${1:-*}; do
		DATE=$(date -R -r ${ID} | sed 's/, \| /|/g')
		echo "${ID#*.} ${DATE}"
	done

	umount /mnt
}

mountroot () {
	menuitems=$(getSnapshots)

	TITLE="Selección del punto de restauración"
	TEXT="Elija punto de restauración a usar para llevar el equipo a un estado anterior:"
	HEIGHT=30
	WIDTH=80
	draw menu 17 ${menuitems} 2> /tmp/answer || cancel_msg

	srcpoint_dir="${INTERVAL}.$(< /tmp/answer)"

	TITLE="Restauración del sistema"
	TEXT="\
		\n \
		\n   Se va a iniciar el proceso para restaurar la copia del sistema: \
		\n   $(getSnapshots ${srcpoint_dir}) \
		\n \
		\n   ¿Desea continuar? \
		\n"
	draw yesno || cancel_msg

	syncronize $srcpoint_dir || error_msg

	success_msg
}

mountroot
