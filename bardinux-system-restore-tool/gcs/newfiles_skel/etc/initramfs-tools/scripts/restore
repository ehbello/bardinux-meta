#!/bin/sh
# Local filesystem mounting			-*- shell-script -*-

# Parameter: Where to mount the filesystem
#

. /scripts/libbsrt

syncronize () {
	SOURCE=$(mount_dev ro ${BACKUPDEV})
	TARGET=$(mount_dev rw ${ROOTDEV})

	TITLE="Restaurando '$1' desde ${BACKUPDEV} a ${ROOTDEV}"
	TEXT="No desconecte el equipo y, por favor, espere a que el proceso termine..."
	WIDTH=60
	rsync -ax --progress --delete ${SOURCE}/${SNAPSHOTDIR}/$1 ${TARGET}/ | dialog ${BACKTITLE:+--backtitle "${BACKTITLE}"} --no-collapse --cr-wrap ${TITLE:+--title "${TITLE}"} --programbox "${TEXT}" ${HEIGHT:-0} ${WIDTH:-0} || cancel_msg
	ERROR=$?
	
	return ${ERROR}
}

getSnapshots() {
	local mntpt=$(mount_dev ro ${BACKUPDEV})
	unset menuitems
	numitems=0
	items=$(ls -1d ${mntpt}/${SNAPSHOTDIR}/${1:-${INTERVAL}.*} | sed 's|./||g' | cut -d "." -f 2 | sort -n)
	for ID in ${items}; do
		DATE=$(date -R -r ${mntpt}/${SNAPSHOTDIR}/${INTERVAL}.${ID}/etc/mtab | /bin/sed 's/, \| /_/g')
		menuitems="${menuitems} ${ID##*.} ${DATE}"
		numitems=$(($numitems + 1))
	done
	umount ${mntpt}
}

getSnapshots

TITLE="Selección del punto de restauración"
TEXT="Elija punto de restauración a usar para llevar el equipo a un estado anterior:"
WIDTH=50
draw menu ${numitems} ${menuitems} 2> /tmp/answer || cancel_msg

SNAPSHOT_ID="${INTERVAL}.$(cat /tmp/answer)"
getSnapshots ${SNAPSHOT_ID}

[ $numitems ] || error_msg "No hay ningún punto de restauración disponible."

TITLE="Restauración del sistema"
TEXT="\
\n   Se va a iniciar el proceso para restaurar la copia del sistema: \
\n   ${menuitems} \
\n \
\n   ¿Desea continuar? \
\n\n"
draw yesno || cancel_msg

syncronize ${SNAPSHOT_ID} || error_msg

success_msg
