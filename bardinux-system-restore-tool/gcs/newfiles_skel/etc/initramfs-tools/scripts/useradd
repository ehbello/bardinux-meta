#!/bin/bash
# Local filesystem mounting			-*- shell-script -*-

# Parameter: Where to mount the filesystem
#

. $(dirname $0)/libbsrt

mountroot () {
	TITLE="Ordenadores de la BULL"
	TEXT="\n\n\n        Bienvenido a la herramienta para crear nuevas cuentas\n    personales en los ordenadores de usuarios de la biblioteca\n    de la Universidad de La Laguna.\n\n       Seguidamente le solicitaremos un nombre de usuario y una\n    clave de acceso para el sistema.\n\n\n\n\n        Oficina de Software Libre de la Universidad de La Laguna."
	draw msgbox

	mount_dev rw ${ROOTDEV} /source
	USERNAME=""
	PASS1=""
	PASS2="OTRO"
	while [ ! $USEROK ]; do
		TITLE="Nuevo usuario"
		TEXT="Escriba su nombre de usuario:\nDebe contener al menos 6 caracteres\ny menos de 13.\n   Ej: alberto, rmartin, etc..."
		draw inputbox 2> /tmp/username || cancelmsg

		USERNAME=$(< /tmp/username)
		if test ${#USERNAME} -lt 6 -o ${#USERNAME} -ge 12; then
			TITLE="Error"
			TEXT="Su nombre de usuario es demasiado largo o demasiado corto ha de tener entre 6 y 12 caracteres" \
			draw msgbox || cancelmsg
		elif echo -n ${USERNAME} | egrep -q -v '^[0-9a-z]*$'; then
			TITLE="Error"
			TEXT="Su nombre solo puede contener digitos y caracteres alfanumericos"
			draw msgbox || cancelmsg
		elif grep -q "^${USERNAME}:" /source/etc/passwd; then
			TITLE="Usuario existente"
			TEXT="Este nombre de usuario ya existe, elija otro"
			draw msgbox || cancelmsg
		else
			USEROK=1
		fi
	done

	while [ "$PASS1" != "$PASS2" ]; do
		TITLE="Configuración de clave"
		TEXT="Escriba su clave de acceso:\nSu clave debe contener al menos 6 caracteres." \
		dialog --title ${TITLE} --insecure --passwordbox ${TEXT} 10 60 2> /tmp/password1 || cancelmsg

		PASS1=$(< /tmp/password1)
		if test ${#PASS1} -lt 6; then
			TITLE="Nuevo usuario para el portatil de la BULL"
			TEXT="Su clave de acceso debe contener al menos 6 caracteres" \
			draw msgbox || cancelmsg
			continue
		fi

		TITLE="Confirmación de clave"
		TEXT="Confirme su clave de acceso:"
		dialog --title ${TITLE}	--insecure --passwordbox ${TEXT} 10 60 2> /tmp/password2 || cancelmsg

		PASS2=$(< /tmp/password2)
		if test "$PASS1" != "$PASS2"; then
			TITLE="Error"
			TEXT="Las claves de acceso no coinciden"
			draw msgbox || cancelmsg
			continue
		fi

	done
	chroot /source /usr/sbin/useradd -mp "$PASS1" "$USERNAME"
	ERROR=$?
		
	#for i in `mount|tr -s "(" " "|tr -s ")" " "|tr -s " " "#"|sed s/on//`;do echo "$i 0 0"|tr -s "#" " ";done > /etc/mtab
	ln -s /proc/mounts /etc/mtab
	if [[ $ERROR == 0 ]]; then
		LIBRE=$(df -h ${ROOTDEV} | tr -s " " "#" | grep home | cut -d "#" -f 4)
		TEXT="Usuario correctamente creado.\n Dispone de $LIBRE de espacio libre.\n\n\n    Pulse Enter para reiniciar"
	else
		TEXT="No se pudo crear el usuario. Contacte con el administrador del sistema.\n\n\n    Pulse Enter para reiniciar"
	fi
	
	success_msg ${TEXT}
}
